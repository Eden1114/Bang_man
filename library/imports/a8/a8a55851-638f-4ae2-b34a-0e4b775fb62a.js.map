{"version":3,"sources":["../../../../assets/script/assets/script/move-control.js"],"names":["cc","Class","extends","Component","properties","_left","_right","_up","_down","moveSpeed","_leftBlock","_rightBlock","_upBlock","_downBlock","realPlayer","_player","onLoad","systemEvent","on","onKeyDown","onKeyUp","node","parent","getChildByName","manager","director","getCollisionManager","enabled","onCollisionEnter","other","self","group","onTouchWall","onCollisionExit","onLeaveWall","blockArray","selfAabb","world","aabb","otherAabb","selfPreAabb","preAabb","otherPreAabb","xMin","xMax","distance","Math","abs","push","direction","yMax","yMin","undefined","name","item","blockName","e","keyCode","KEY","up","down","left","scaleX","children","right","update","dt","targetVector","pSub","position","moveStep","pMult","pNormalize","x","y","pAdd"],"mappings":"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","file":"move-control.js","sourceRoot":"../../../../assets/script","sourcesContent":["/** 通过键盘↑↓←→和space控制移动和防止炸弹*/\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        _left: false,\n        _right: false,\n        _up: false,\n        _down: false,\n\n        moveSpeed: 0,\n\n        _leftBlock: 0,\n        _rightBlock: 0,\n        _upBlock: 0,\n        _downBlock: 0,\n\n        realPlayer: false,\n        _player: null,\n    },\n\n    onLoad: function () {\n        if (this.realPlayer) {\n            //移动功能 开启按键的监听\n            cc.systemEvent.on('keydown', this.onKeyDown, this);\n            cc.systemEvent.on('keyup', this.onKeyUp, this);\n        } else {\n            this._player = this.node.parent.getChildByName('player');\n        }\n        //碰撞功能 先打开碰撞回调\n        let manager = cc.director.getCollisionManager();\n        manager.enabled = true;\n    },\n\n    onCollisionEnter: function (other, self) {\n        if (other.node.group == 'static-wall' || other.node.group == 'boom') {\n            //如果碰撞的分组是墙壁 调用↓\n            this.onTouchWall(other, self);\n        }\n    },\n\n    onCollisionExit: function (other, self) {\n        if (other.node.group == 'static-wall' || other.node.group == 'boom') {\n            //离开墙壁的时候，记得解除碰撞的标志位\n            this.onLeaveWall(other, self);\n        }\n    },\n\n    onTouchWall: function (other, self) {\n        //check the preAabb and aabb\n\n        let blockArray = [];\n        //aabb是碰撞发生后嵌入墙壁的包围盒↓\n        let selfAabb = self.world.aabb;\n        let otherAabb = other.world.aabb;\n        //preAabb是碰撞发生前一帧，未碰撞 还在墙壁外的包围盒↓\n        let selfPreAabb = self.world.preAabb;\n        let otherPreAabb = other.world.preAabb;\n\n        //preAabb not touch by aabb touch => the edge blockArray\n\n        //check left block\n        //判断碰撞确实发生的思路是： preAabb的时候某边未嵌入墙壁 但是aabb的时候这个边已经嵌入了墙壁\n        //就说明 这preAabb到aabb这个切换过程中，这个边确实碰到了墙壁\n        //上下左右四个边都判断一次\n        if (selfPreAabb.xMin >= otherAabb.xMax && selfAabb.xMin <= otherAabb.xMax) {\n            //left block\n            let distance = Math.abs(otherAabb.xMax - selfPreAabb.xMin);\n            //然后就保存碰撞的边\n            blockArray.push({ distance: distance, direction: 'left' });\n        }\n        //check right block\n        if (selfPreAabb.xMax <= otherAabb.xMin && selfAabb.xMax >= otherAabb.xMin) {\n            //right block\n            let distance = Math.abs(otherAabb.xMin - selfPreAabb.xMax);\n            blockArray.push({ distance: distance, direction: 'right' });\n        }\n        //check up block\n        if (selfPreAabb.yMax <= otherAabb.yMin && selfAabb.yMax >= otherAabb.yMin) {\n            //up block\n            let distance = Math.abs(otherAabb.yMin - selfPreAabb.yMax);\n            blockArray.push({ distance: distance, direction: 'up' });\n        }\n        //check down block\n        if (selfPreAabb.yMin >= otherAabb.yMax && selfAabb.yMin <= otherAabb.yMax) {\n            //down block\n            let distance = Math.abs(otherAabb.yMax - selfPreAabb.yMin);\n            blockArray.push({ distance: distance, direction: 'down' });\n        }\n        //让墙壁帮我们保存碰撞的数组\n        if (other.blockArray == undefined) { other.blockArray = {}; }\n        other.blockArray[self.node.name] = blockArray;\n\n        //遍历碰撞的数组 设置碰撞的标志位\n        for (let item of blockArray) {\n            let blockName = '_' + item.direction + \"Block\";\n            this[blockName] += 1;\n        }\n    },\n\n    onLeaveWall: function (other, self) {\n        //和touchWall部分同理\n        if (other.blockArray !== undefined && other.blockArray[self.node.name] !== undefined) {\n            for (let item of other.blockArray[self.node.name]) {\n                let blockName = '_' + item.direction + 'Block';\n                //不过这次是解除\n                this[blockName] -= 1;\n            }\n            //然后清空碰撞数组\n            other.blockArray[self.node.name] = [];\n        }\n    },\n\n    onKeyDown: function (e) {\n        //在按下的时候设置方向标志位\n        switch (e.keyCode) {\n            case cc.KEY.up: { this._up = true; break }\n            case cc.KEY.down: { this._down = true; break }\n            case cc.KEY.left: { this._left = true; this.node.scaleX = -1; this.node.children[0].scaleX = -1; break }\n            case cc.KEY.right: { this._right = true; this.node.scaleX = 1; this.node.children[0].scaleX = 1; break }\n        }\n    },\n\n    onKeyUp: function (e) {\n        //在弹起的时候解除方向标志位\n        switch (e.keyCode) {\n            case cc.KEY.up: { this._up = false; break }\n            case cc.KEY.down: { this._down = false; break }\n            case cc.KEY.left: { this._left = false; break }\n            case cc.KEY.right: { this._right = false; break }\n        }\n    },\n    \n    // onAllDirectionMove: function(dx, dy) {\n    //     this._player.x += dx;\n    //     this._player.y += dy;\n    \n    \n    // },\n\n    update: function (dt) {\n        //然后根据标志位移动玩家\n        //能够移动的判断标准是  想往某个方向移动并且那个方向畅通无阻 才能移动\n        if (!this.realPlayer) {\n            //计算玩家位置并不断追逐\n            let targetVector = cc.pSub(this._player.position, this.node.position);\n            let moveStep = cc.pMult(cc.pNormalize(targetVector), this.moveSpeed);\n            if (moveStep.x > 0 && !!this._rightBlock) { moveStep.x = 0; }\n            if (moveStep.x < 0 && !!this._leftBlock) { moveStep.x = 0; }\n            if (moveStep.y > 0 && !!this._upBlock) { moveStep.y = 0; }\n            if (moveStep.y < 0 && !!this._downBlock) { moveStep.y = 0; }\n            if (moveStep.x > 0) { this.node.scaleX = 1; this.node.children[0].scaleX = 1; }\n            if (moveStep.x < 0) { this.node.scaleX = -1; this.node.children[0].scaleX = -1; }\n            this.node.position = cc.pAdd(this.node.position, moveStep);\n        } else {\n\n            if (this._left && !this._leftBlock) { this.node.x -= this.moveSpeed }\n            if (this._right && !this._rightBlock) { this.node.x += this.moveSpeed }\n            if (this._up && !this._upBlock) { this.node.y += this.moveSpeed }\n            if (this._down && !this._downBlock) { this.node.y -= this.moveSpeed }\n        }\n    }\n});\n"]}