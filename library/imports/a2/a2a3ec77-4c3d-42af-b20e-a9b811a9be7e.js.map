{"version":3,"sources":["../../../../assets/script/assets/script/player-control.js"],"names":["cc","Class","extends","Component","properties","hp","realPlayer","hurtValue","_hpLabel","get","node","getChildByName","getComponent","Label","_sceneLoading","hurtDurationOfEnemyTouch","_hurtTimeStamp","_enemyRemoving","_gridControl","onLoad","director","getCollisionManager","enabled","enabledDebugDraw","enabledDrawBoundingBox","require","Date","now","string","on","onHurt","manager","onCollisionStay","other","self","group","checkGridTouch","otherNode","selfNode","otherGrid","getGrid","position","selfGrid","x","y","loadScene","window","enemyNum","removeFromParent"],"mappings":"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","file":"player-control.js","sourceRoot":"../../../../assets/script","sourcesContent":["cc.Class({\n    extends: cc.Component,\n\n    properties: {\n        hp: 100,    //当前剩余的血量\n        realPlayer: false,\n        hurtValue: 5,   //受伤害时，扣除的hp量\n        _hpLabel: {\n            get: function () {\n                return this.node.getChildByName('hp-tips').getComponent(cc.Label);\n            }\n        },  //用于放置血量的label\n        _sceneLoading: false,\n        hurtDurationOfEnemyTouch: 0.5,  //just use in enemy\n        _hurtTimeStamp: null,\n        _enemyRemoving: false,\n        _gridControl: null,\n    },\n\n    onLoad: function () {\n        \n        //DEBUG\n        cc.director.getCollisionManager().enabled = true;\n        cc.director.getCollisionManager().enabledDebugDraw = true;\n        cc.director.getCollisionManager().enabledDrawBoundingBox = true;\n\n\n        this._gridControl = require('grid-control');\n        this._hurtTimeStamp = Date.now();\n\n        this._hpLabel.string = this.hp; //设置hp\n        this.node.on('hurt-by-power', this.onHurt, this);   //收到伤害时执行的函数\n        let manager = cc.director.getCollisionManager();\n        manager.enabled = true;\n\n    },\n\n\n    onCollisionStay: function (other, self) {\n        if (this.realPlayer && other.node.group == 'player') {\n            //[add] check the grid\n            if (this.checkGridTouch(other.node, self.node)) {\n                if (this._hurtTimeStamp + this.hurtDurationOfEnemyTouch * 1000 <= Date.now()) {\n                    this.onHurt();\n                    this._hurtTimeStamp = Date.now();\n                }\n            }\n        }\n    },\n\n    checkGridTouch: function (otherNode, selfNode) {\n        let otherGrid = this._gridControl.getGrid(otherNode.position);\n        let selfGrid = this._gridControl.getGrid(selfNode.position);\n        if (otherGrid.x == selfGrid.x && otherGrid.y == selfGrid.y) {\n            return true;\n        } else {\n            return false;\n        }\n    },\n\n    \n    // 受到伤害时\n    onHurt: function () {\n        this.hp -= this.hurtValue;\n        if (this.hp <= 0) {\n            if (this.realPlayer) {\n                //game over\n                if (!this._sceneLoading) {\n                    this._sceneLoading = true;\n                    cc.director.loadScene('game-over-scene');\n                }\n            } else {\n                //enemy removed\n                if (!this._enemyRemoving) {\n                    this._enemyRemoving = true;\n                    window.enemyNum--;\n                    this.node.removeFromParent();\n                }\n            }\n        } else {\n            this._hpLabel.string = this.hp;\n        }\n\n    }\n\n});\n"]}