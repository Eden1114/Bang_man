function dependOn(){"use strict";return[require("util"),require("common"),require("proxy"),require("communicate"),require("analytics")]}var def;require=function(a){"use strict";return a},def=window.define?window.define:function(a,b){"use strict";return b.apply(null,[{ajax:$.ajax.bind($)}])};var exports=acom_analytics={};def(dependOn(),function(a,b,c,d,e){"use strict";function k(){var d,f,g;this.proxy=c.proxy.bind(this),this.LOG=b.LOG,this.updateName=function(d,e){if(!d||!e)return a.Deferred().resolve().promise();var f=b.settings.files_api+"assets/"+d+"/metadata/name",g=JSON.stringify({value:e,on_dup_name:"auto_rename"});return a.ajax({type:"PUT",url:f,data:g,headers:b.POST_headers()}).then(function(){},this.proxy(function(a){c.REST_error(a,this,{url:f,data:g})}))},this.updateParent=function(d,e){if(!d||!e)return a.Deferred().resolve().promise();var f=b.settings.files_api+"assets/"+g.assetId+"/metadata/parent_id",h=JSON.stringify({value:e,on_dup_name:"auto_rename"});return a.ajax({type:"PUT",url:f,data:h,headers:b.POST_headers()}).then(function(){},this.proxy(function(a){c.REST_error(a,this,{url:f,data:h})}))},this.rename=function(b){var c=a.Deferred();return this.updateName(b.assetId,b.filename).then(this.proxy(function(){this.updateParent(b.assetId,b.dest_folder).then(function(){c.resolve()},function(){c.reject()})}),function(){c.reject()}),c.promise()},this.gotoPath=function(c){var d=a.Deferred();g.userSelectPromise?g.userSelectPromise.then(function(){d.resolve()},function(){d.reject()}):d.resolve(),d.then(this.proxy(function(){b.sso_url(c).then(this.proxy(function(b){f?(a.isChrome()&&chrome.tabs.update(f,{url:b.uri,active:!0}),f=null):a.createTab(b.uri)}),this.proxy(function(d){c=b.settings.cloud_host+c,f?(a.isChrome()&&chrome.tabs.update(f,{url:c,active:!0}),f=null):a.createTab(c)}))}))},this.file_spec_done=function(a){g.dest_folder=a.dest_folder;var b=g.filename;"zip"!==b.substring(b.length-3,b.length)&&(g.filename=a.filename),g.upload_promise.then(this.proxy(function(){this.rename(g).then(function(){g.userSelectPromise.resolve()},function(){g.userSelectPromise.reject()})}))},this.message=function(b,c,d){f&&a.sendMessage({tabId:f,progress_op:d?"set-error":"set-text",text:b,busy:c})},this.foundCode=function(a){var c=a.split("?")[1].split("=")[1].split("&")[0];this.newSession(null,!0),e.event(e.e.SIGN_IN_COMPLETE),b.authorize(c).then(function(){d&&d.resolve(),d=null},function(){d&&d.reject(),d=null})},this.sessionRequest=function(a,b){g=a,g.params=b||{filename:g.filename}},this.send_folders=function(){this.signed_in().then(this.proxy(function(){e.event(e.e.UPLOAD_RENAME_CLICKED),a.ajax({type:"POST",headers:b.POST_headers(),url:b.settings.files_api+"search",data:JSON.stringify({q:{object_type:"folder"},metadata:["id","name","created","parent_id"]})}).then(this.proxy(function(c){f&&(c.results.push({parent_id:null,object_type:"root",created:"2015-03-31T11:37:40",id:b.settings.files_root,name:"/"}),a.sendMessage({tabId:f,progress_op:"folders",folders:c.results}))}),this.proxy(function(a,b,d){c.REST_error(a,this)}))}))},this.newSession=function(b,c,d){d||(d=g.params),d.filename&&(g.userSelectPromise=a.Deferred()),b||(a.isChrome()&&(b=chrome.runtime.getURL("data/js/progress.html")+"#"+a.param(d)),d.filename&&this.send_folders()),f?a.isChrome()&&chrome.tabs.update(f,{url:b,active:!0}):(a.isChrome()&&chrome.tabs.create({url:b},this.proxy(function(a){c&&(f=a.id)})),a.isFF()&&require("sdk/windows").browserWindows.open({url:b}))},this.sign_in=function(c,f){return d&&(d.reject(),d=null,e.event(e.e.SIGN_IN_ABANDONED)),d=a.Deferred(),b.baseUris().then(this.proxy(function(){var c={client_id:b.settings.ims_client_id,redirect_uri:b.settings.redirect_uri,scope:"AdobeID, skybox, openid",dc:!1},d=b.settings.ims_host+"ims/authorize/v1?"+a.param(c);e.event(e.e.SIGN_IN_SHOWN),this.newSession(d,!0)})),d.promise()},this.signed_in=function(){return d?d:a.Deferred().resolve().promise()},this.signOut=function(){a.isChrome()&&chrome.tabs.create({url:b.settings.ims_host+"ims/logout/v1?"+a.param({access_token:b.settings.auth_token.replace(/Bearer /,""),client_id:b.settings.ims_client_id,client_secret:b.settings.ims_client_secret,redirect_uri:"https://adobe.com"})}),b.clearAuth()},this.checkSessionTab=function(a,b){a===f&&b.indexOf("chrome-extension:")===-1&&b.indexOf(".adobe.com/")===-1&&(f=null,d&&(d.reject(),d=null,e.event(e.e.SIGN_IN_ABANDONED)))},this.goto_acom=function(c){SETTINGS.USE_ACROBAT?a.createTab(b.settings.cloud_host):(this.sessionRequest(c,{}),this.gotoPath("files"))},this.html_to_pdf=function(b,c){b.filename=c.tab.title.replace(/[\*"\/\\'&\.]/g,"")+".pdf",this.sessionRequest(b,{filename:b.filename,message:"Gathering HTML Content",busy:"true",progress_op:"htmlToPdf"}),this.sign_in(b,c).then(this.proxy(function(){a.isChrome()&&chrome.tabs.executeScript(b.tabId,{code:"var maxSize= "+SETTINGS.MAX_HTML_SIZE+", DEBUG = "+SETTINGS.DEBUG_MODE+", TABID = "+b.tabId+", OP = 'html-blob', EXCLUDE = [];",allFrames:!0},function(){chrome.tabs.executeScript(b.tabId,{file:"data/js/get-html.js",allFrames:!0})})}))},this.relay_message=function(b){b.complete?b.error?(a.consoleLog(b.error),e.event(e.e.HTML_SOURCE_SIZE_TOO_LARGE_ERROR)):(b.html_op="serialize_iframe",a.isChrome()&&chrome.tabs.executeScript(b.tabId,{code:"if (window.dc && window.OP) { receiveIframe("+JSON.stringify(b)+"); }",allFrames:!0})):a.isChrome()&&chrome.tabs.executeScript(b.tabId,{code:"if (window.dc && window.OP) {serialize("+JSON.stringify(b)+"); }",allFrames:!0})},this.flickr=function(a){this.sessionRequest(a,{}),this.newSession(null,!1,{unavailable:"flickr"})},this.error=function(b){if(f){g&&g.userSelectPromise&&g.userSelectPromise.reject();var c=["Please Report this Error:"];a.each(b,function(a,b){c.push(a+": "+b)}),this.message(c.join("\n"),!1,!0),f=null}},c.handlers(this.error.bind(this)),a.isChrome()&&chrome.tabs.onRemoved.addListener(function(a){a===f&&(f=null,d&&(e.event(e.e.SIGN_IN_ABANDONED),d.reject(),d=null))}),this.html_blob=function(b){if(b.error)a.consoleError(b.error),e.logError(b.error,b.analytics[0]);else{e.logContents(b),e.checkAndLogHTMLBlobSize(b.blob.currentSize/1048576),b.analytics&&e.setParamsAndLogAnalytics(b.analytics,e.e.HTML_SOURCE_CONTENT,"content"),e.setArg("stage","CLONE"),e.checkAndLogTimingRange(b.cloneTiming),a.consoleLog("html blob send to:"+f);var c=JSON.stringify(b.blob);i().compress(c,g)}}}var g,h,i,f=null;h=function(){return d.getModule("upload")},i=function(){return d.getModule("convert-to-zip")},f||(f=new k,d.registerHandlers({goto_acom:f.proxy(f.goto_acom),html_to_pdf:f.proxy(f.html_to_pdf),flickr:f.proxy(f.flickr),file_spec_done:f.proxy(f.file_spec_done),"html-blob":f.proxy(f.html_blob),"relay-msg":f.proxy(f.relay_message)}),d.registerModule("session",f));for(g in f)f.hasOwnProperty(g)&&("function"==typeof f[g]?exports[g]=f[g].bind(f):exports[g]=f[g]);return f});