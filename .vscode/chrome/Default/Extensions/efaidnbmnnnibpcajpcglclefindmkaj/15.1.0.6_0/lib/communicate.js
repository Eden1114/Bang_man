function dependOn(){"use strict";return[require("util"),require("common"),require("analytics"),require("proxy")]}var def;require=function(a){"use strict";return a},def=window.define?window.define:function(a,b){"use strict";return b.apply(null,[{ajax:$.ajax.bind($)}])};var exports=acom_analytics={};def(dependOn(),function(a,b,c,d){"use strict";function i(){var e={},i={};this.proxy=d.proxy.bind(this),this.LOG=b.LOG,this.registerHandlers=function(b){a.extend(e,b)},this.registerModule=function(a,b){g[a]=b},this.getModule=function(a){return g[a]},this.reset=function(a,d){b.reset(a.environment),c.setAnalyticsUsage(a.analytics_on,d.tab.id),a.environment&&(c.environment=a.environment,c.event(c.e.OPTIONS_SET_ENV))},this.registerHandlers({reset:this.proxy(this.reset)}),this.version=-1,this.legacyShim=function(){return this.version<=1},this.setVersion=function(a){this.version=a},this.handler=function(b,d,f){var i;if(b&&(this.dump(b,"Communicate Handler receive: "),d&&d.tab&&(b.tabId=d.tab.id,h||(h=d.tab.id),b.main_op)))return"relay_to_content"===b.main_op?(delete b.main_op,void this.sendMessage(b)):(c.logBrowserAnalytics(b),i=b.main_op,delete b.main_op,"dismiss"===i&&this.closeDialog(),e[i]?(c.setOp({preview:"Copy",image_preview:"Image",send:"Send",fillsign:"FillSign",export:"Export",acom:"GotoAcom",to_pdf:"ConvertToPdf"}[b.handleResult]),e[i](b,d,f)):void a.consoleLog("failed to find handler for: "+i))},this.closeDialog=function(){a.isFF()&&this.globals.panel.hide()},this.echo=function(b){var d,e,f,g,h;if(SETTINGS.CHROME_VERSION<SETTINGS.SUPPORTED_VERSION)return f=this.getModule("session"),void f.newSession("data/js/options.html",!0,{});if(c.event(c.e.TREFOIL_CLICKED),this.avoidUrl(b.url))return void this.disable(b.id);if(a.isFF())d=this.lastRequest||{panel_op:"html_menu"};else if(i[b.id]){if(d=i[b.id],"cancelled"!==d.current_status&&"pdf_opened"!==d.current_status||(h=d.is_pdf,this.clearStatus(d),d.is_pdf=h),d.current_status&&(d.panel_op="status"),g=this,"mac"===SETTINGS.OS)return f=g.getModule("session"),void f.newSession("data/js/options.html?os=mac",!0,{});e=d.is_pdf?"pdf_menu":"html_menu",d.panel_op=d.panel_op||e,a.consoleLog("repeat cached request: "+d.panel_op)}d&&(d.trefoilClick=!0,this.sendMessage(d))},this.setGlobals=function(a){this.globals=a},this.dump=function(b,c){var d,e=[c];for(d in b)b.hasOwnProperty(d)&&e.push("  "+d+": "+b[d]);a.consoleLog(e.join("\n"))},this.sendMessage=function(b){var e,d=b.tabId;this.dump(b,"Sending message:"),b.version=this.version,i[d]=a.extend(i[d],b),"pdf_menu"===b.panel_op&&(e=b.trefoilClick?c.e.TREFOIL_PDF_FROM_CLICK:c.e.TREFOIL_PDF_MENU_SHOWN),"flickr"===b.panel_op&&(e=c.e.FLICKR_OFFER_SHOWN),"html_menu"===b.panel_op&&(e=c.e.TREFOIL_HTML_FROM_CLICK),e&&c.checkAndLogAnalytics(e),a.sendMessage(b,this.globals),delete b.trefoilClick},this.deferMessage=function(a){"undefined"==typeof setTimeout?this.sendMessage(a):setTimeout(this.proxy(this.sendMessage,a),0)},this.filenameFromUrl=function(a){var b=decodeURIComponent(a.replace(/\S*\//,""));return b.replace(/[\?#]\S*/,"")},this.pdf_menu=function(b,c){var f,d=this;"mac"!==SETTINGS.OS&&(f=i[c.tab.id]=a.extend(i[c.tab.id],{tabId:c.tab.id}),f.filename=d.filenameFromUrl(b.url),f.panel_op="pdf_menu",f.url=b.url,f.is_pdf=!0,"false"!==a.getCookie("always-show-pdf-menu")&&d.deferMessage(f))},this.loaded=function(b){i[b]=a.extend(i[b],{tabId:b,loaded:!0}),this.enable(b)},this.clearStatus=function(a,b){"in_progress"!==a.current_status&&"downloading"!==a.current_status&&(b||"waiting"!==a.current_status)&&(this.getModule("acro-web2pdf").cancelConversion(a.tabId),delete a.current_status,delete a.file_path,delete a.domtitle,delete a.timing,delete a.panel_op,delete a.is_pdf)},this.loading=function(b){var c=b.id;i[c]=a.extend(i[c],{tabId:c,loaded:!1}),this.clearStatus(i[c],!0),this.enable(c)},this.active=function(b){h=b.tabId,i[h]=a.extend(i[h],{tabId:b.tabId})},this.enable=function(a){var b=i[a].loaded?"data/images/acrobat_dc_appicon_24.png":"data/images/acrobat_dc_appicon_24_translucent.png";chrome.browserAction.setIcon({path:b,tabId:a}),i[a].loaded?chrome.browserAction.enable(a):chrome.browserAction.disable(a)},this.disable=function(a){i[a]&&(i[a].loaded=!1,this.enable(a))},this.close=function(a){this.getModule("acro-web2pdf").cancelConversion(a),delete i[a],h===a&&(h=null)},this.tabReplace=function(a,b){this.close(b),this.loaded(a)},this.activeTab=function(){return h},this.noop=function(){},this.avoidUrl=function(a){return a=a||"",this.version===SETTINGS.ERP_READER_VER||(!!a.startsWith("https://chrome.google.com")||(!a.endsWith(".pdf")&&!a.endsWith(".PDF")&&this.version===SETTINGS.READER_VER||!a.startsWith("http")))}}var f,h,e=null,g={};e||(e=new i,a.isChrome()&&(chrome.runtime.onMessage.addListener(e.proxy(e.handler)),chrome.tabs.onActivated.addListener(e.proxy(e.active)),chrome.tabs.onRemoved.addListener(e.proxy(e.close)),chrome.tabs.onCreated.addListener(e.proxy(e.loading)),chrome.tabs.onReplaced.addListener(e.proxy(e.tabReplace))));for(f in e)e.hasOwnProperty(f)&&("function"==typeof e[f]?exports[f]=e[f].bind(e):exports[f]=e[f]);return e.registerHandlers({"send-analytics":e.proxy(e.noop)}),e});